/*
============================================================================
* Dokumentname: _dbquery.js
* Beschreibung: JavaScript für die Streamforge-Webseite Webprojekt FS2025
* Autoren:      Kjell Mühlhoff, Eric Pernet
============================================================================
*/


//URL der Webseite
const url = 'http://localhost:8080/';

// HTML-Elemente referenzieren
let Suche = document.getElementById("Suche");
let answerMusician = document.getElementById("answerMusician");
let answerURL = document.getElementById("answerURL");
let videoFrame = document.getElementById("URL");
let answerGenre = document.getElementById("answerGenre");
let answerDate = document.getElementById("answerDate");
let answerAlbum = document.getElementById("answerAlbum");
let answerTitel = document.getElementById("answerTitel");
let Genrelist = document.getElementById("Genrelist");

// Titelfelder
let answerSongTITEL = document.getElementById("answerSongTITEL");
let answerAlbumTITEL = document.getElementById("answerAlbumTITEL");
let answerGenreTITEL = document.getElementById("answerGenreTITEL");
let answerErscheinungsdatumTITEL = document.getElementById("answerErscheinungsdatumTITEL");
let answerMusikerTITEL = document.getElementById("answerMusikerTITEL");
let answerURLTITEL = document.getElementById("answerURLTITEL");
let answerLIEDERTITEL = document.getElementById("answerLIEDERTITEL");

let InsertTitel = document.getElementById("InsertTitel");
let InsertPlaylist = document.getElementById("InsertPlaylist");
let playliständerung = document.getElementById("playliständerung");
let Playlistlieder = document.getElementById("Playlistlieder");
let loginbestätigung = document.getElementById("loginbestätigung");
let passwort = document.getElementById("passwort");
let benutzername = document.getElementById("benutzername");

// Song-Suchfunktion:
async function songHandler() {
    if (Suche.value !== '') {
        try {
            let response = await fetch(url + 'db/Titel/' + Suche.value);
            if (response.ok) {
                let json = await response.json();   //Unten werden alle Elemente aus der Datenbank ausgegeben, die dem "Titel" entsprechen
                Suche.textContent = json[0].Titel;
                answerTitel.textContent = json[0].Titel;
                answerMusician.textContent = json[0].Künstler;
                answerURL.textContent = json[0].URL;
                answerDate.textContent = json[0].Erstellungsdatum;
                answerAlbum.textContent = json[0].Album;
                answerGenre.textContent = json[0].Genre;

                // Einzelne Untertitel für Ergebnisse
                answerSongTITEL.textContent = "Song:";
                answerAlbumTITEL.textContent = "Album:";
                answerGenreTITEL.textContent = "Genre:";
                answerErscheinungsdatumTITEL.textContent = "Erscheinungsdatum:";
                answerMusikerTITEL.textContent = "Musiker:";
                answerURLTITEL.textContent = "URL:";
                answerLIEDERTITEL.textContent = "";
                Genrelist.textContent = "";

                videoFrame.src = json[0].URL;
            }
        } catch (error) {
            console.error("Error:", error);
        }
    }
}

//Suchfunktion nach Album (Funktioniert gleich wie "SongHandler()")

async function albumHandler() {
    if (Suche.value !== '') {
        try {
            let response = await fetch(url + 'db/Album/' + Suche.value);
            if (response.ok) {
                let json = await response.json();
                Suche.textContent = json[0].Album;
                answerTitel.textContent = json[0].Titel;
                answerMusician.textContent = json[0].Künstler;
                answerDate.textContent = json[0].Erstellungsdatum;
                answerAlbum.textContent = json[0].Album;
                answerGenre.textContent = json[0].Genre;

                answerSongTITEL.textContent = "";
                answerAlbumTITEL.textContent = "Album:";
                answerGenreTITEL.textContent = "Genre:";
                answerErscheinungsdatumTITEL.textContent = "Erscheinungsdatum:";
                answerMusikerTITEL.textContent = "Musiker:";
                answerLIEDERTITEL.textContent = "Lieder:";

                videoFrame.src = json[0].URL;
            }
        } catch (error) {
            console.error("Error:", error);
        }
    }
}

//Suchfunktion nach Genre (Ebenfalls gleiche Funktionsweise)
async function genreHandler() {
    if (Suche.value !== '') {
        try {
            let response = await fetch(url + 'db/Genre/' + Suche.value);
            if (response.ok) {
                let json = await response.json();

                answerLIEDERTITEL.textContent = "Lieder:";

                // Felder leeren, da diese bei der Ausgabe der Lieder eines Genres nicht mehr benötigt werden
                Suche.textContent = "";
                answerTitel.textContent = "";
                answerMusician.textContent = "";
                answerDate.textContent = "";
                answerAlbum.textContent = "";
                answerGenre.textContent = "";
                answerURL.textContent = "";
                answerURLTITEL.textContent = "";
                answerSongTITEL.textContent = "";
                answerAlbumTITEL.textContent = "";
                answerGenreTITEL.textContent = "";
                answerErscheinungsdatumTITEL.textContent = "";
                answerMusikerTITEL.textContent = "";

                let resultString = "";
                for (let i = 0; i < json.length; i++) {
                    resultString += "\n" + json[i].Titel;
                }

                Genrelist.textContent = resultString;
                videoFrame.src = json[0].URL;
            }
        } catch (error) {
            console.error("Error:", error);
        }
    }
}

//Wechsel auf die Homepage bzw. der kleineren Webseiten

async function playlistswebsite() {
    window.location.href = "Playlists.html";
}

async function impressumwebsite() {
    window.location.href = "Impressum.html";
}

async function Homepage() {
    window.location.href = "_dbquery.html";
}

//Login-Funktion

async function login() {
    try {
        let passworthash = hashCode(passwort.value);
        console.log(passworthash);

        let response = await fetch(url + 'db/' + benutzername.value + '/' + passworthash);
        if (response.ok) {
            let json = await response.text();
            console.log(`Message erhalten: ${json}`);

            if (json === "Login erfolgreich") {
                window.location.href = "_dbquery.html";
            } else {
                loginbestätigung.textContent = json;
            }
        }
    } catch (error) {
        console.log(error);
    }
}

// Hash-Funktion

function hashCode(str) {
    let hash = 0;
    for (let i = 0, len = str.length; i < len; i++) {
        let chr = str.charCodeAt(i);
        hash = (hash << 5) - hash + chr;
        hash |= 0;
    }
    return hash;
}

//Funktion, um Song zu einer Playlist hinzuzufügen

async function insertSong() {
    try {
        let response = await fetch(url + InsertTitel.value + '/' + InsertPlaylist.value);
        if (response.ok) {
            let json = await response.text();
            playliständerung.textContent = json;
        }
    } catch (error) {
        console.log(error);
    }
}

//Anzeige eines Songs in einer Playlist

async function searchPlaylist() {
    if (InsertPlaylist.value !== '') {
        try {
            let response = await fetch(url + InsertPlaylist.value);
            if (response.ok) {
                let json = await response.json();
                let resultString = "";
                for (let i = 0; i < json.length; i++) {
                    resultString += json[i].Songs_Songname + ",\n";
                }
                Playlistlieder.textContent = resultString;
            }
        } catch (error) {
            console.error("Error:", error);
        }
    }
}

//Funktion, um einer Playlist zu folgen

async function followPlaylist() {
    try {
        let response = await fetch(url + 'Datenbank/Benutzer_Benutzername/' + InsertPlaylist.value);
        if (response.ok) {
            let json = await response.text();
            playliständerung.textContent = json;
        }
    } catch (error) {
        console.log(error);
    }
}

// Funktion, um eine Playlist anzuzeigen

async function showPlaylist() {
    try {
        let response = await fetch(url + 'Datenbank/likes/Benutzer/Playlists');
        if (response.ok) {
            let json = await response.json();
            let resultString = "";
            for (let i = 0; i < json.length; i++) {
                resultString += json[i].Playlists_Playlistname + ",\n";
            }
            Playlistlieder.textContent = resultString;
        }
    } catch (error) {
        console.error("Error:", error);
    }
}
